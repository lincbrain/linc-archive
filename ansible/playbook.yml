---
- name: Deploy https://girder.dandiarchive.org/
  hosts: all
  vars:
    ansible_python_interpreter: auto

  roles:
    - role: girder.mongodb
      vars:
        mongodb_data_path: /var/lib/mongodb
    - role: girder.girder
    - role: girder.nginx
      vars:
        nginx_hostname: "girder.dandiarchive.org"
        nginx_registration_email: "michael.grauer@kitware.com"

  tasks:
    - name: Install awscli
      apt:
        name: awscli
        update_cache: true
      become: true

    - name: Create .aws directory
      file:
        path: "{{ ansible_env.HOME }}/.aws"
        state: directory

    - name: Copy aws config file required for public S3 bucket in separate aws account
      copy:
        src: files/config
        dest: "{{ ansible_env.HOME }}/.aws/config"

    - name: Install Girder plugins
      pip:
        name:
          - girder-oauth
          - girder-sentry
          - girder-download-statistics
          - "git+https://github.com/dandi/dandiarchive@{{ lookup('env', 'CIRCLE_SHA1') }}#subdirectory=girder-dandi-archive"
        virtualenv: "{{ girder_virtualenv }}"
        state: latest
      notify:
        - Build Girder web client
        - Restart Girder

    - name: Remove Girder plugins
      pip:
        name:
          - girder-hashsum-download
        virtualenv: "{{ girder_virtualenv }}"
        state: absent
      notify:
        - Build Girder web client
        - Restart Girder
